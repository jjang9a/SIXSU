<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/template}"
>
  <head>
    <meta charset="UTF-8" />
    <title>출고관리</title>
  </head>
  <body>
    <div layout:fragment="content">
      <h1 class="mt-4" style="font-family: 'MaruBuri'">출고관리</h1>
      <h3 class="mt-4" style="font-family: 'MaruBuri'">주문현황</h3>
      상품명 <input type="text" name="cpName" id="cpNameBox" />
      <button
        type="button"
        data-bs-toggle="modal"
        id="searchProductBtn"
        class="sixBtn1"
        target="#searchModal"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="14"
          height="18"
          fill="currentColor"
          class="bi bi-search"
          viewBox="0 2 16 16"
        >
          <path
            d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"
          />
        </svg></button
      ><br />
      상품코드 <input type="text" name="cpId" id="cpIdBox" /> <br />
      입고일자 <input type="date" name="startPro" id="startPro" />
      <input type="date" name="endPro" id="endPro" /> <br />
      <button class="sixBtn2" id="infoCollect">조회</button>
      <button class="sixBtn4" id="infoCollect">초기화</button><br />

      <div id="orderListGrid"></div>

      <!-- 상품목록 모달창 -->
      <div
        class="modal fade"
        id="productModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="searchModalLabel">
                  상품 목록 조회
                </h1>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>

              <div class="btns"></div>

              <div class="modal-body">
                <div id="gridp"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
      <h3 class="mt-4" style="font-family: 'MaruBuri'">출고대기</h3>
     
       <div id="orderReadyGrid"></div>
      </div>
      <!-- lot별 품목 모달창 -->
      <div
        class="modal fade"
        id="lotModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="searchModalLabel">
                  LOT별 재고 현황
                </h1>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>

              <div class="btns">
                상품명:
                <input type="text" name="cpId" id="cpOrdNameBox" readonly />
                <br />
                상품코드:
                <input type="text" name="cpCode" id="cpOrdCode" readonly />
                <br />
                주문수량:
                <input type="text" name="ordQt" id="cpOrdQt" readonly /><br />
                총재고량:
                <input type="text" name="totalQt" id="totalQt" readonly />
                <br />
              </div>

              <div class="modal-body">
                <div id="lotProductGrid"></div>
                <button class="sixBtn4" id="search1-btn">출고시작</button>
               
              </div>
            </div>
          </div>
        </div>
      </div>
      
      
      <!-- 출고대기 검사가완료된 품목 모달창 -->
      <div
        class="modal fade"
        id="shipReadyModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="searchModalLabel">
                 검사완료
                </h1>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>

              <div class="btns"></div>

              <div class="modal-body">

              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
      
      
        //상품조회 모달창 부분
        $("#searchProductBtn").on("click", function (e) {
          $("#productModal").modal("show");
          $.ajax({
            url: "/sales/products",
            method: "get",
            dataType: "JSON",
            success: function (result) {
              gridp.resetData(result);
              console.log("거래처 모달");
              setTimeout(() => gridp.refreshLayout(), 1000);
            },
          });
        });
        const gridp = new tui.Grid({
          el: document.getElementById("gridp"),
          //data : gridData,
          scrollX: false,
          scrollY: false,
          pageOptions: {
            useClient: true,
            perPage: 10,
          },
          columns: [
            {
              header: "완제품 코드",
              name: "cpId",
            },
            {
              header: "완제품 이름",
              name: "cpName",
            },
            {
              header: "완제품 규격",
              name: "cpSize",
            },
          ],
        });
        gridp.on("click", (ev) => {
          const focusCell = gridp.getFocusedCell();
          let dataRow = gridp.getRow(ev.rowKey);
          $("#cpNameBox").val(dataRow.cpName);
          $("#cpIdBox").val(dataRow.cpId);
          $("#productModal").modal("hide");
        });

        
        
        /*--------------------------------
    	//주문서 상세 목록 모달창
    	---------------------------------*/	
        const orderListGrid = new tui.Grid({
          el: document.getElementById("orderListGrid"),
          //data : gridData,
          scrollX: false,
          scrollY: false,
          pageOptions: {
            useClient: true,
            perPage: 10,
          },
          columns: [
            {
              header: "주문날짜",
              name: "ordDate",
            },
            {
              header: "납기일자",
              name: "ordEndDate",
            },
            {
              header: "주문코드",
              name: "ordId",
            },
            {
              header: "주문상세코드",
              name: "ordDetId",
            },
            {
              header: "제품코드",
              name: "cpId",
            },
            {
              header: "제품명",
              name: "cpName",
            },
            {
              header: "주문수량",
              name: "ordQt",
            },
            {
              header: "관리 lot 수량",
              name: "cpLot",
              hidden : true
            }
          ],
        });
        $.ajax({
          url: "/sales/orderedList",
          method: "get",
          dataType: "JSON",
          success: function (result) {
            orderListGrid.resetData(result);
            console.log("출고대기 주문서들");
            setTimeout(() => orderListGrid.refreshLayout(), 400);
          },
        });

        let orderData = '';
        
        // 주문현황을 클릭시 관련된 상품이 모달창에 lot 별재고 현황
        orderListGrid.on("click", (ev) => {
          const focusCell = orderListGrid.getFocusedCell();
          let dataRow = orderListGrid.getRow(ev.rowKey);
          orderData = dataRow;
          $.ajax({
            url: "/sales/lotProducts",
            method: "get",
            data: { result: dataRow.cpId },
            success: function (result) {
	              lotProductGrid.resetData(result);
	              console.log("lot별 재고현황");
	              setTimeout(() => lotProductGrid.refreshLayout(), 1000);
	              $("#lotModal").modal("show");
	              $("#cpOrdNameBox").val(dataRow.cpName);
	              $("#cpOrdCode").val(dataRow.cpId);
	              $("#cpOrdQt").val(dataRow.ordQt);
            },
          });          
         //lot 별재고 현황에서 완제품 총재고량 띄우는 기능
          $.ajax({
            url: "/sales/totalQt",
            method: "GET",
            data: { result: dataRow.cpId },
            success: function (result) {
	              $("#totalQt").val(result);
            },
          });
        });
         //lot별 재고현황 모달창 그리드        
        const lotProductGrid = new tui.Grid({
          el: document.getElementById("lotProductGrid"),
          //data : gridData,
          scrollX: false,
          scrollY: false,

          pageOptions: {
            useClient: true,
            perPage: 10,
          },
          columns: [
            {
              header: "완제품 LOT",
              name: "cpLotId",
            },
            {
              header: "완제품 코드",
              name: "cpId",
            },
            {
              header: "완제품 이름",
              name: "cpName",
            },
            {
              header: "완제품 수량",
              name: "cpLotQt",
            },
          ],
        });
        //모달창 안에 있는 출고시작 버튼
        $('#search1-btn').on('click', function(){
        	console.log(orderData);
        	$.ajax({
				url: "/sales/shipPro",
				method: "POST",
				dataType: "JSON",
				contentType: "application/json",
				data: JSON.stringify(orderData),
				success: function(result){
					let appData = result;
					
				},
				error: function (reject) {
					console.log(reject)
					alert('출고 과정에서 에러가 발생하였습니다.')
				}
        	})
        })
        
        //출고대기 테이블의 품목 (검사요청과, 검사완료가 보여지는 테이블)
        $.ajax({
	          url: "/sales/readyShipList",
	          method: "get",
	          dataType: "JSON",
	          success: function (result) {
	        	  	orderReadyGrid.resetData(result);
	            	console.log("검사대기 출고품들");
	            	setTimeout(() => orderReadyGrid.refreshLayout(), 400);
          },
        });
        //출고대기 테이블 그리드
        const orderReadyGrid = new tui.Grid({
        el: document.getElementById("orderReadyGrid"),
          scrollX: false,
          scrollY: false,

          pageOptions: {
            useClient: true,
            perPage: 10,
            },
          columns: [
        	{
              header: "주문상세코드",
              name: "ordDetId",
              rowSpan: true
            },
        	{
              header: "완제품 출고코드",
              name: "cpShipId",
            },
            {
              header: "완제품 LOT 코드",
              name: "cpLotId",
            },
            {
              header: "출고 수량",
              name: "cpShipQt",
            },
            {
              header: "출고 요청일자",
              name: "cpShipReqDate",
            },
            {
              header: "출고진행상태",
              name: "cpShipStat",
            },
            {
              header: "검사번호",
              name: "inspNum",
              hidden: true
            },
          ],
        });
        //출고대기테이블 품목을 클릭시 출고를 완료하는기능
            orderReadyGrid.on('click', ev =>{
            	if(ev.columnName == 'ordDetId'){	
            	 	const focusCell = orderReadyGrid.getFocusedCell()
                 	let dataRow = orderReadyGrid.getRow(ev.rowKey);
            	 	console.log (dataRow);
            	 	
            	 	if(dataRow.cpShipStat == "검사요청"){
            	 		alert("아직 모든 물품이 출고검사가 끝나지 않았습니다.")
            	 	}
            	 	else if(dataRow.cpShipStat == "검사완료"){
            	 		$("#shipReadyModal").modal("show");
            	 		
            	 	}
            	} 
            })
             
		        
      </script>
    </div>
  </body>
</html>
