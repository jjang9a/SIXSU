<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/template}">

<head>
	<meta charset="UTF-8">
	<title>자재발주관리</title>
	<style>
		#gridm .redcolor{
			background-color : #ffe4e4
		}
		#gridm .yellowcolor{
			background-color : #e8f71c63
		}
	
	</style>
</head>

<body>
	<div layout:fragment="content">
		<h1 class="mt-4" style="font-family: 'MaruBuri';">자재 발주 관리</h1>
		<form action="" method="post" id="reqForm">
				<table id="reqTable">
					<tr>
						<td>발주번호</td>
						<td><input type="text" name="matReqId" id="matReqId" class="empty" placeholder="검색"></td>
					</tr>
					<tr>
						<td>자재명</td>
						<td><input type="text" name="matName" id="matName" class="empty" placeholder="검색">
						</td>
					</tr>
					<tr>
						<td>거래처명</td>
						<td><input type="text" name="busName" id="busName" class="empty" placeholder="검색">
						</td>
					</tr>
					<tr>
						<td>발주등록일자</td>
						<td>
							<input type="date" id="matInSDate"> ~ <input type="date" id="matInEDate">
						</td>
					</tr>
					<tr>
						<td>발주상태</td> 
						<td>
						<input type="radio" id="matReqStat1" name="matReqStat" value="">
								<label for="matHoldStat1">전체</label>
						<input type="radio" th:each="req: ${REQSTAT}" th:value="${req.value}" th:text="${req.text}" name="matReqStat"></td> 
					</tr>
					<tr>
						<td>납기일자</td>
						<td>
							<input type="date" id="matEndSDate"> ~ <input type="date" id="matEndEDate">
						</td>
					</tr>
				</table>
			</form>
			<div class="divBtn">
				<button type="button" class="sixBtn2" id="check">조회</button>
				<button type="button" class="sixBtn3" id="reset">초기화</button>
			</div>
		
			
			<div class="rightBtn">
				<button class="sixBtn4" id="appendBtn" onclick="appendBtn">발주등록</button>
				<button class="sixBtn2" id="updateBtn">수정</button>
				<button class="sixBtn2" id="delete">삭제</button>
			</div>

		
		<!-- 발주 목록 그리드 -->
		<div id="grid"></div>
		
		<!-- 모달창 자재조회  -->
		<div class="modal fade" id="msearchModal" tabindex="-1"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-body">
							<div id="gridm"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 모달창 거래조회  -->
		<div class="modal fade" id="search1Modal" tabindex="-1"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-body">
							<div id="gridt"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script th:inline="javascript">
			let reqStat = [[${REQSTAT}]];
			let transPro='';
		
			const gridData = [

			];


			
				
				function setRowDisabled(grid) {
					let rowList = grid.getData();
					rowList.forEach((obj) => {
						if(obj.matReqStat != 'A'){ 
							grid.disableRow(obj.rowKey, true);
						}
					});
				}
				
				function matReqList(){
					$.ajax({
						url: "/materials/matreqlist",
						method: "GET",
						dataType: "JSON",
						success: function (result) {
							grid.resetData(result);
							gridInsertRow();
							grid.setValue(0, 'matReqStat', "A", false);
							setRowDisabled(grid);
						},
						error: function(reject){
							console.log(reject);
						}
						
					});
				}
				
				function matReqSearch(matReqId, matName, busName, matReqStat, matInSDate, matInEDate, matEndSDate, matEndSDate, matEndEDate){
					$.ajax({
						url: "/materials/matreqsearch",
						method: "GET",
						data : {matReqId : matReqId, matName : matName, busName : busName, matReqStat : matReqStat, matInSDate : matInSDate,
								matInEDate : matInEDate, matEndSDate : matEndSDate, matEndSDate : matEndSDate, matEndEDate : matEndEDate},
						success: function (result) {
							grid.resetData(result);
							setRowDisabled(grid);
						},
						error: function(reject){
							console.log(reject);
						}
						
					});
				}
				
				
				let matReqId = null;
				let matName = null;
				let busName = null;
				let matReqStat = null;
				let matInSDate = null;
				let matInEDate = null;
				let matEndSDate = null;
				let matEndEDate = null;
				
				
				matReqList();



				
				//모달창 전체 거래처 리스트
				$.ajax({
					url : "/materials/matreqbuslist",
					method : "GET",
					dataType : "JSON",
					success : function(result) {
						gridt.resetData(result);
					},
 					error: function(reject) {
						console.log(reject);
					}
				});
				$('#search1Modal').on('show.bs.modal',function(e){
					console.log ('거래처 모달');
					setTimeout(()=>gridt.refreshLayout(),200);
					// 모달거래처행 클릭시 자동으로 조회 거래처명에 값이 입력이됨
					gridt.on('click', ev=> {
					      const focusCell = gridt.getFocusedCell()
					      let dataRow = gridt.getRow(ev.rowKey);
					      $('#search1Modal').modal('hide');
					});
				})	
				
				//모달창 전체 자재명 리스트
				$.ajax({
					url : "/materials/matlist",
					method : "GET",
					dataType : "JSON",
					success : function(result) {
						gridm.resetData(result);
						gridm.getData().forEach(ele=>{
							if(ele.matSafe/2>ele.matQtSum){
								gridm.addCellClassName(ele.rowKey, 'matId','redcolor');
								gridm.addCellClassName(ele.rowKey, 'matName','redcolor');
								gridm.addCellClassName(ele.rowKey, 'matSize','redcolor');
								gridm.addCellClassName(ele.rowKey, 'matUnit','redcolor');
								gridm.addCellClassName(ele.rowKey, 'matSafe','redcolor');
								gridm.addCellClassName(ele.rowKey, 'matQtSum','redcolor');
							}else if((ele.matSafe)>ele.matQtSum){
								//gridm.addRowClassName(ele.rowKey,'yellowcolor');
								gridm.addCellClassName(ele.rowKey, 'matId','yellowcolor');
								gridm.addCellClassName(ele.rowKey, 'matName','yellowcolor');
								gridm.addCellClassName(ele.rowKey, 'matSize','yellowcolor');
								gridm.addCellClassName(ele.rowKey, 'matUnit','yellowcolor');
								gridm.addCellClassName(ele.rowKey, 'matSafe','yellowcolor');
								gridm.addCellClassName(ele.rowKey, 'matQtSum','yellowcolor');
							}
						});
					},
 					error: function(reject) {
						console.log(reject);
					}
				});
				$('#msearchModal').on('show.bs.modal', function(e){
					console.log ('자재 모달');
					setTimeout(()=>gridm.refreshLayout(),200);
					// 모달자재행 클릭시 자동으로 조회 자재명에 값이 입력이됨
					gridm.on('click', ev=> {
				      const focusCell = gridm.getFocusedCell()
				      let dataRow = gridm.getRow(ev.rowKey);
				      $('#msearchModal').modal('hide');
				    });
					
				})
			
			
			//테이블에 들어갈 데이터 설정(조회)
			const grid = new tui.Grid({
				el: document.getElementById('grid'),
				
				scrollX: false,
				scrollY: false,
				pageOptions: {
					useClient: true,
					perPage: 10
				},
				rowHeaders: ['checkbox'],


				columns: [{
						header: '발주번호',
						name: 'matReqId'
					},
					{
						header: '자재코드',
						name: 'matId',
						editor: 'text'
					},
					{
						header: '자재명',
						name: 'matName'
					},
					{
						header: '규격',
						name: 'matSize'
					},
					{
						header: '발주량',
						name: 'matReqQt',
						editor: 'text'
					},
					{
						header: '거래처코드',
						name: 'busId',
						editor: 'text'
						
					},
					{
						header: '거래처명',
						name: 'busName',
					},
					{
						header: '발주일',
						name: 'matReqDate'
					},
					{
						header: '발주상태',
						name: 'matReqStat',
						formatter: 'listItemText',
				         editor: {
				            type: 'select',
				            options: {
				              listItems:reqStat
				            }
				         }
					},
					{
						header: '납기요청일',
						name: 'matEndDate',
						editor: {
						      type: 'datePicker',
						      options: {
						        format: 'yyyy-MM-dd'
						      }
						    }
					},
					{
						header: '담당자',
						name: 'empName'
					}
					

				]
				
			});

		    // 거래처조회 기능
			const gridt = new tui.Grid({
				el : document.getElementById('gridt'),
				scrollX : false,
				scrollY : false,
				pageOptions: {
					useClient: true,
					perPage: 10
				},
				minBodyHeight: 400,
				columns : [ 
					{
					header : '거래처번호',
					name : 'busId',
				}, {
					header : '거래처명',
					name : 'busName'
				}, {
					header : '사업자번호',
					name : 'busNum'
				}, {
					header : '전화번호',
					name : 'busTell'
				}, {
					header : '주소',
					name : 'busAddr'
				}]
			});
		    
			// 모달자재조회 기능
			const gridm = new tui.Grid({
				el : document.getElementById('gridm'),
				//data : gridData,
				scrollX : false,
				scrollY : false,
				pageOptions: {
					useClient: true,
					perPage: 10
				},
				minBodyHeight: 400,
				rowHeaders: ['rowNum'],
				columns : [ 
					{
					header : '자재코드',
					name : 'matId',
				}, {
					header : '자재명',
					name : 'matName'
				}, {
					header : '자재규격',
					name : 'matSize'
				}, {
					header : '단위',
					name : 'matUnit'
				}, {
					header : '안전재고',
					name : 'matSafe'
				}, {
					header : '현재고',
					name : 'matQtSum'
				}]
			});
	


  			tui.Grid.applyTheme('default', {
				cell: {
					header: {
						background: '#e5edf5'
					},
					disabled : {
						text : '#000'
					}
				}
			});

			//발주 등록
			$('#appendBtn').on("click", function () {
				grid.blur();
				$.ajax({
					url: "/materials/matreqlist",
					method: "GET",
					dataType: "JSON",
					success: function (result) {
						grid.resetData(result);
						gridInsertRow();
						$.ajax({
							url: "/materials/matreqlist",
							method: "GET",
							dataType: "JSON",
							success: function (result) {
								grid.setValue(0, 'matReqStat', "A", false);
								grid.setValue(0, 'busId', grid.getRow(1).busId , false);
								grid.setValue(0, 'busName', grid.getRow(1).busName , false);
							},
		 					error: function(reject){
								console.log(reject);
							}
						
						});
					},
 					error: function(reject){
						console.log(reject);
					}
				
				});
 				console.log(JSON.stringify(grid.getRow(0)));
 				let insertData = JSON.stringify(grid.getRow(0));
 				$.ajax({
					url: "/materials/insertmatreq",
					type: "POST",
					data: insertData,
					contentType: 'application/json',
					//data : {list : JSON.stringify(matReqIds)},
					//data :{matReqId : grid.getCheckedRows()[0].matReqId},
					success: function (result) {
						console.log(result);
						alert('발주 등록 완료');
						matReqList();
					},
 					error: function(reject){
						console.log(reject);
						alert('발주 등록 실패');
					}

				})
				
 				
 			});

			//체크된 항목 삭제	    
			$('#delete').on("click", function () {

				$.ajax({
					url: "/materials/delmatreq",
					type: "POST",
					contentType: 'application/json',
					data: JSON.stringify(grid.getCheckedRows()),
					success: function (result) {
						console.log(result);
						alert('삭제 완료');
					},
 					error: function(reject){
						console.log(reject);
					}
				})


				grid.removeCheckedRows(false);
				grid.blur();
				
				
			});
			
			//체크된 항목 수정
 			$('#updateBtn').on('click', function () {
 				console.log(JSON.stringify(grid.getCheckedRows()));
				$.ajax({
					url: "/materials/updatematreq",
					type: "POST",
					contentType: 'application/json',
					data: JSON.stringify(grid.getCheckedRows()),
					success: function (result) {
						alert('수정 완료');
						console.log(result);
						$.ajax({
							url: "/materials/matreqlist",
							method: "GET",
							dataType: "JSON",
							success: function (result) {
								grid.resetData(result);
								gridInsertRow();
								grid.setValue(0, 'matReqStat', "A", false);
								setRowDisabled(grid);
								
							},
							error: function(reject){
								console.log(reject);
							}
							
						});
					},
 					error: function(reject){
						console.log(reject);
					}
				})
			}) 
			
			//조회하기
			$('#check').on("click", function () {
				matReqId = $('#matReqId').val();
				matName = $('#matName').val();
				busName = $('#busName').val();
				matReqStat = $("input[name='matReqStat']:checked").val();
				matInSDate = $('#matInSDate').val();
				matInEDate = $('#matInEDate').val();
				matEndSDate = $('#matEndSDate').val();
				matEndEDate = $('#matEndEDate').val();
				matReqSearch(matReqId, matName, busName, matReqStat, matInSDate, matInEDate, matEndSDate, matEndSDate, matEndEDate);
				
			});

			//초기화 버튼 설정
			$('#reset').on("click", function (e) {
				$('#matReqId').val('');
				$('#matName').val('');
				$('#busName').val('');
				$("input[name='matReqStat']:checked").val();
				$('#matInSDate').val('');
				$('#matInEDate').val('');
				$('#matEndSDate').val('');
				$('#matEndEDate').val('');
				$('input[type="radio"]').prop('checked', false);
				matReqList();
				
			});
			
			function gridInsertRow(){
				let prevData = grid.getData();
				
				for(let row of prevData){
					row.rowKey += 1;
				}
				prevData.splice(0, 0, {});
				
				grid.resetData(prevData);
			}

			
	    	let selectRow = '';
	    	grid.on('click', ev=> {
	    		selectRow = ev.rowKey;
	    		const focusCell = grid.getFocusedCell();
	    		//console.log(focusCell);
	    		const dataRow = grid.getRow(ev.rowKey);
	    		//console.log(dataRow.matReqStat);
	    		if(dataRow.matReqStat == 'A' && focusCell.columnName == 'matId'){
			    	   	$('#msearchModal').modal('show');
			    	   	
			    }else if (dataRow.matReqStat == 'A' && focusCell.columnName == 'busId'){
			    		$('#search1Modal').modal('show');
			    		
			    }				
	    	});
	    	gridm.on('click', evm=> {
    	   		{
	    	   		let dataRow = gridm.getRow(evm.rowKey);
	    	   		console.log(dataRow);
	    	   		grid.setValue(selectRow, 'matId', dataRow.matId, false);
	    	   		grid.setValue(selectRow, 'matName', dataRow.matName, false);
	    	   		grid.setValue(selectRow, 'matSize', dataRow.matSize, false);
	    	   		selectRow='';
	    	   		$('#msearchModal').modal('hide');
			    	grid.blur();
    	   		}
			});
	    	
	    	gridt.on('click', evt=> {
    			{
    				let dataRow = gridt.getRow(evt.rowKey);
    				grid.setValue(selectRow, 'busId', dataRow.busId, false)
    				grid.setValue(selectRow, 'busName', dataRow.busName, false)
    				selectRow='';
    				$('#search1Modal').modal('hide');
    		    	grid.blur();
    			}
    		});
	    	
		</script>
	</div>
</body>

</html>