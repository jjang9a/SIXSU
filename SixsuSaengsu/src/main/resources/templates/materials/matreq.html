<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/template}">

<head>
	<meta charset="UTF-8">
	<title>자재발주관리</title>
</head>

<body>
	<div layout:fragment="content">
		<h1 class="mt-4" style="font-family: 'MaruBuri';">자재 입고 관리</h1>
		<form action="" method="post" id="reqForm">
				<table id="reqTable">
					<tr>
						<td>발주번호</td>
						<td><input type="text" name="mreq" id="mreq" class="empty" placeholder="검색"></td>
					</tr>
					<tr>
						<td>자재명</td>
						<td><input type="text" name="mname" id="mname" class="empty" placeholder="검색"><button type="button" data-bs-toggle="modal" id="search1Btn"
							class="sixBtn2" data-bs-target="#search1Modal">
							<svg xmlns="http://www.w3.org/2000/svg" width="14" height="18" fill="currentColor" class="bi bi-search"
								viewBox="0 2 16 16">
								<path
									d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
							</svg></button>
						</td>
					</tr>
					<tr>
						<td>거래처명</td>
						<td><input type="text" name="bname" id="bname" class="empty" placeholder="검색"><button type="button" data-bs-toggle="modal" id="search1Btn"
							class="sixBtn2" data-bs-target="#search1Modal">
							<svg xmlns="http://www.w3.org/2000/svg" width="14" height="18" fill="currentColor" class="bi bi-search"
								viewBox="0 2 16 16">
								<path
									d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
							</svg></button>
						</td>
					</tr>
					<tr>
						<td>발주등록일자</td>
						<td>
							<input type="date" id="matStartDate"> ~ <input type="date" id="matStartDatee">
						</td>
					</tr>
					<tr>
						<td>발주상태</td> 
						<td><input type="radio" th:each="req: ${REQSTAT}" th:value="${req.value}" th:text="${req.text}" name="req"></td> 
					</tr>
					<tr>
						<td>납기일자</td>
						<td>
							<input type="date" id="matEndDate"> ~ <input type="date" id="matEndDatee">
						</td>
					</tr>
				</table>
			</form>
			<div class="divBtn">
				<button type="button" class="sixBtn2" id="check" onclick="getList();">조회</button>
				<button type="button" class="sixBtn3" id="reset">초기화</button>
			</div>
		
			
			<div class="rightBtn">
				<button class="sixBtn4" id="appendBtn" onclick="appendBtn">발주등록</button>
				<button class="sixBtn2" id="updateBtn">수정</button>
				<button class="sixBtn2" id="delete">삭제</button>
			</div>

		
		<!-- 발주 목록 그리드 -->
		<div id="grid"></div>
		
		<!-- 모달창 자재조회  -->
		<div class="modal fade" id="msearchModal" tabindex="-1"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="msearchModalLabel">자재명 조회</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<div class="btns">
							자재명 <input id="msearch-text" />
							<button class="sixBtn2" id="msearch-btn">조회</button>
							<button class="sixBtn2" id="mreset-btn">초기화</button>
						</div>
						<div class="modal-body">
							<div id="gridm"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 모달창 거래조회  -->
		<div class="modal fade" id="search1Modal" tabindex="-1"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="searchModalLabel">거래처 조회</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<div class="btns">
							거래처명: <input id="search1-text" />
							<button class="sixBtn2" id="search1-btn">조회</button>
							<button class="sixBtn2" id="reset1-btn">초기화</button>
						</div>
						<div class="modal-body">
							<div id="gridt"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script th:inline="javascript">
		let reqStat = [[${REQSTAT}]];
		let transPro='';
		
			const gridData = [

			];


			window.onload = function () {
				
				function setRowDisabled(grid) {
					let rowList = grid.getData();
					rowList.forEach((obj) => {
						if(obj.matReqStat != 'A'){ 
							grid.disableRow(obj.rowKey, false);
						}
					});
				}
				
				$.ajax({
					url: "/materials/matreqlist",
					method: "GET",
					dataType: "JSON",
					success: function (result) {
						grid.resetData(result);
						gridInsertRow();
						grid.setValue(0, 'matReqStat', "A", false);
						setRowDisabled(grid);
					},
					error: function(reject){
						console.log(reject);
					}
					
				});



				
				//모달창 전체 거래처 리스트
				$.ajax({
					url : "/sales/busList",
					method : "GET",
					dataType : "JSON",
					success : function(result) {
						gridt.resetData(result);
					},
 					error: function(reject) {
						console.log(reject);
					}
				});
				$('#search1Modal').on('show.bs.modal',function(e){
					console.log ('거래처 모달');
					setTimeout(()=>gridt.refreshLayout(),200);
					// 모달거래처행 클릭시 자동으로 조회 거래처명에 값이 입력이됨
					gridt.on('click', ev=> {
					      const focusCell = gridt.getFocusedCell()
					      let dataRow = gridt.getRow(ev.rowKey);
					      $('#bname').val(dataRow.busName);
					      $('#search1Modal').modal('hide');
					});
				})	
				
				//모달창 전체 자재명 리스트
				$.ajax({
					url : "/materials/matlist",
					method : "GET",
					dataType : "JSON",
					success : function(result) {
						gridm.resetData(result);
					},
 					error: function(reject) {
						console.log(reject);
					}
				});
				$('#msearchModal').on('show.bs.modal', function(e){
					console.log ('자재 모달');
					setTimeout(()=>gridm.refreshLayout(),200);
					// 모달자재행 클릭시 자동으로 조회 자재명에 값이 입력이됨
					gridm.on('click', ev=> {
				      const focusCell = gridm.getFocusedCell()
				      let dataRow = gridm.getRow(ev.rowKey);
				      $('#mname').val(dataRow.matName);
				      $('#msearchModal').modal('hide');
				    });
					
				})
			};
			
			//테이블에 들어갈 데이터 설정(조회)
			const grid = new tui.Grid({
				el: document.getElementById('grid'),
				
				scrollX: false,
				scrollY: false,
				pageOptions: {
					useClient: true,
					perPage: 10
				},


				
				rowHeaders: ['checkbox'],


				columns: [{
						header: '발주번호',
						name: 'matReqId'
					},
					{
						header: '자재코드',
						name: 'matId',
						editor: 'text'
					},
					{
						header: '자재명',
						name: 'matName'
					},
					{
						header: '규격',
						name: 'matSize'
					},
					{
						header: '발주량',
						name: 'matReqQt',
						editor: 'text'
					},
					{
						header: '거래처코드',
						name: 'busId',
						editor: 'text'
						
					},
					{
						header: '거래처명',
						name: 'busName',
					},
					{
						header: '발주일',
						name: 'matReqDate'
					},
					{
						header: '발주상태',
						name: 'matReqStat',
						 formatter: 'listItemText',
				          editor: {
				            type: 'select',
				            options: {
				              listItems:reqStat
				            }
				          }
					},
					{
						header: '납기요청일',
						name: 'matEndDate',
						editor: {
						      type: 'datePicker',
						      options: {
						        format: 'yyyy-MM-dd'
						      }
						    }
					},
					{
						header: '담당자',
						name: 'empName'
					}
					

				]
				
			});

		    // 거래처조회 기능
			const gridt = new tui.Grid({
				el : document.getElementById('gridt'),
				scrollX : false,
				scrollY : false,
				columns : [ 
					{
					header : '거래처번호',
					name : 'busId',
				}, {
					header : '거래처명',
					name : 'busName'
				}, {
					header : '사업자번호',
					name : 'busNum'
				}, {
					header : '전화번호',
					name : 'busTell'
				}, {
					header : '주소',
					name : 'busAddr'
				}]
			});
		    
			// 모달자재조회 기능
			const gridm = new tui.Grid({
				el : document.getElementById('gridm'),
				scrollX : false,
				scrollY : false,
				columns : [ 
					{
					header : '자재코드',
					name : 'matId',
				}, {
					header : '자재명',
					name : 'matName'
				}, {
					header : '자재규격',
					name : 'matSize'
				}]
			});
	


  			tui.Grid.applyTheme('default', {
				cell: {
					header: {
						background: '#e5edf5'
					},
					disabled : {
						text : '#000'
					}
				}
			});

			
			//등록버튼을 누르면 추가
					
			$('#appendBtn').on("click", function () {
				
				$.ajax({
					url: "/materials/matreqlist",
					method: "GET",
					dataType: "JSON",
					success: function (result) {
						grid.resetData(result);
						gridInsertRow();
						$.ajax({
							url: "/materials/matreqlist",
							method: "GET",
							dataType: "JSON",
							success: function (result) {
								grid.resetData(result);
								gridInsertRow();
								grid.setValue(0, 'busId', grid.getRow(1).busId , false);
								grid.setValue(0, 'busName', grid.getRow(1).busName , false);
							},
		 					error: function(reject){
								console.log(reject);
							}
						
						});
					},
 					error: function(reject){
						console.log(reject);
					}
				
				});
 				console.log(JSON.stringify(grid.getRow(0)));
 				let insertData = JSON.stringify(grid.getRow(0));
 				$.ajax({
					url: "/materials/insertmatreq",
					type: "POST",
					data: insertData,
					contentType: 'application/json',
					//data : {list : JSON.stringify(matReqIds)},
					//data :{matReqId : grid.getCheckedRows()[0].matReqId},
					success: function (result) {
						console.log(result);
						alert('발주 등록 완료');
					},
 					error: function(reject){
						console.log(reject);
						alert('발주 등록 실패');
					}

				})
				
 				
 			});
 			
			
			//그리드 안의 내용 콘솔 찍어보기
/* 			grid.on('click', ev=> {
				grid.on('click', ev=> {
		               console.log(ev.rowKey)
		               console.log(ev.columns)
		               //grid.addSelectionOnly(ev.rowKey);
		               const focusCell = grid.getFocusedCell()
		               console.log(focusCell)
		               
		               let dataRow = grid.getRow(ev.rowKey);
		               console.log(dataRow);
		               console.log('발주번호 : ' + dataRow.matReqId);
		            })
			})  */



			//체크된 항목 삭제	    
			$('#delete').on("click", function () {
				console.log(grid.getCheckedRows());
				console.log(grid.getCheckedRows().length);
				var matReqIds = [];
				console.log("abcd");
				for (var i = 0; i < grid.getCheckedRows().length; i++) {
					console.log(grid.getCheckedRows()[i].matReqId);
					matReqIds.push(grid.getCheckedRows()[i].matReqId);

				}

				$.ajax({
					url: "/materials/delmatreq",
					type: "POST",
					contentType: 'application/json',
					data: JSON.stringify(grid.getCheckedRows()),
					success: function (result) {
						console.log(result);
						alert('삭제 완료');
					},
 					error: function(reject){
						console.log(reject);
					}
				})


				grid.removeCheckedRows(false);
				grid.blur();
				
				
			});
			
 			$('#updateBtn').on('click', function () {
 				console.log(JSON.stringify(grid.getCheckedRows()));
				$.ajax({
					url: "/materials/updatematreq",
					type: "POST",
					contentType: 'application/json',
					data: JSON.stringify(grid.getCheckedRows()),
					success: function (result) {
						alert('수정 완료');
						console.log(result);
						$.ajax({
							url: "/materials/matreqlist",
							method: "GET",
							dataType: "JSON",
							success: function (result) {
								grid.resetData(result);
								gridInsertRow();
								grid.setValue(0, 'matReqStat', "A", false);
								setRowDisabled(grid);
								
							},
							error: function(reject){
								console.log(reject);
							}
							
						});
					},
 					error: function(reject){
						console.log(reject);
					}
				})
			}) 
			
			//조회하기
			$('#check').on("click", function () {

				const reqNum = $('#reqNum').val();
				console.log(reqNum);
				const matEndDate = $('#matEndDate').val();
				console.log(matEndDate);
			});

			//초기화 버튼 설정
			$('#reset').on("click", function (e) {
				$('#reqNum').val('');
				$('#mname').val('');
				$('#bname').val('');
				$('#matStartDate').val('');
				$('#matStartDatee').val('');
				$('#matEndDate').val('');
				$('#matEndDatee').val('');

				//location.reload();

				$.ajax({
					url: "/materials/mms",
					method: "GET",
					dataType: "JSON",
					success: function (result) {
						grid.resetData(result);
						gridInsertRow();
					},
 					error: function(reject){
						console.log(reject);
					}
				});
				
			});
			
			function gridInsertRow(){
				let prevData = grid.getData();
				
				for(let row of prevData){
					row.rowKey += 1;
				}
				prevData.splice(0, 0, {});
				
				grid.resetData(prevData);
			}

			
	    	let selectRow = '';
	    	grid.on('click', ev=> {
	    		abc = ev.rowKey;
	    		const focusCell = grid.getFocusedCell();
	    		//console.log(focusCell);
	    		const dataRow = grid.getRow(ev.rowKey);
	    		//console.log(dataRow.matReqStat);
	    		if(dataRow.matReqStat == 'A' && focusCell.columnName == 'matId'){
			    	   	$('#msearchModal').modal('show');
			    	   	
			    }else if (dataRow.matReqStat == 'A' && focusCell.columnName == 'busId'){
			    		$('#search1Modal').modal('show');
			    		
			    }				
	    	});
	    	gridm.on('click', evm=> {
    	   		{
	    	   		let dataRow = gridm.getRow(evm.rowKey);
	    	   		console.log(dataRow);
	    	   		grid.setValue(abc, 'matId', dataRow.matId, false);
	    	   		grid.setValue(abc, 'matName', dataRow.matName, false);
	    	   		grid.setValue(abc, 'matSize', dataRow.matSize, false);
	    	   		abc='';
	    	   		$('#msearchModal').modal('hide');
			    	grid.blur();
    	   		}
			});
	    	
	    	gridt.on('click', evt=> {
    			{
    				let dataRow = gridt.getRow(evt.rowKey);
    				grid.setValue(abc, 'busId', dataRow.busId, false)
    				grid.setValue(abc, 'busName', dataRow.busName, false)
    				abc='';
    				$('#search1Modal').modal('hide');
    		    	grid.blur();
    			}
    		});
	    	
	    	function getList(){
	    		var opts = $('#mreq')
	    		grid.readData(1,opts,true)
	    	}
		</script>
	</div>
</body>

</html>